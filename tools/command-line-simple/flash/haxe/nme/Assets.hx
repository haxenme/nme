package nme;

import nme.display.BitmapData;
import nme.media.Sound;
import nme.net.URLRequest;
import nme.text.Font;
import nme.utils.ByteArray;
import ApplicationMain;

import haxe.ds.StringMap;

class Assets 
{
   public static var cachedBitmapData:StringMap<BitmapData> = new StringMap<BitmapData>();

   private static var initialized:Bool = false;
   private static var resourceClasses:StringMap <Dynamic> = new StringMap <Dynamic> ();
   private static var resourceTypes:StringMap <String> = new StringMap <String> ();

   private static function initialize():Void 
   {
      if (!initialized) 
      {
         ::foreach assets::resourceClasses.set("::id::", NME_::flatName::);
         resourceTypes.set("::id::", "::type::");
         ::end::
         initialized = true;
      }
   }

   public static function getBitmapData(id:String, useCache:Bool = false):BitmapData 
   {
      initialize();

      if (resourceTypes.exists(id) && resourceTypes.get(id) == "image") 
      {
         if (useCache && cachedBitmapData.exists(id)) 
         {
            return cachedBitmapData.get(id);

         }
         else
         {
            var data = cast(Type.createInstance(resourceClasses.get(id), []), BitmapData);

            if (useCache) 
            {
               cachedBitmapData.set(id, data);
            }

            return data;
         }

      }
      else
      {
         trace("[nme.Assets] There is no BitmapData asset with an ID of \"" + id + "\"");

         return null;
      }
   }

   public static function getBytes(id:String):ByteArray 
   {
      initialize();

      if (resourceClasses.exists(id)) 
      {
         return cast(Type.createInstance(resourceClasses.get(id), []), ByteArray);

      }
      else
      {
         trace("[nme.Assets] There is no String or ByteArray asset with an ID of \"" + id + "\"");

         return null;
      }
   }

   public static function getFont(id:String):Font 
   {
      initialize();

      if (resourceTypes.exists(id) && resourceTypes.get(id) == "font") 
      {
         return cast(Type.createInstance(resourceClasses.get(id), []), Font);

      }
      else
      {
         trace("[nme.Assets] There is no Font asset with an ID of \"" + id + "\"");

         return null;
      }
   }

   public static function getSound(id:String):Sound 
   {
      initialize();

      if (resourceTypes.exists(id)) 
      {
         if (resourceTypes.get(id) == "sound" || resourceTypes.get(id) == "music") 
         {
            return cast(Type.createInstance(resourceClasses.get(id), []), Sound);
         }
      }

      trace("[nme.Assets] There is no Sound asset with an ID of \"" + id + "\"");

      return null;
   }

   public static function getText(id:String):String 
   {
      var bytes = getBytes(id);

      if (bytes == null) 
      {
         return null;

      }
      else
      {
         return bytes.readUTFBytes(bytes.length);
      }
   }
}
